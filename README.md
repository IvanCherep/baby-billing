# Baby-billing
## _Приложение в микросервисной архитектуре эмулирующее работу биллинговой системы_
Практическое задание на Nexign Bootcamp 2024. <br>

**О проекте:** Приложение логически делится на 2 части:
* Биллинговая система:
	* BRT-севрис. Сервис авторизации клиентов, хранения и изменения информации об абонентах.
	* HRS-сервис. Сервис расчета стоимости конкретных услуг для конкретных пользователей.
* Система генерации данных:
	* CDR-сервис. Сервис эмулции работы коммутатора и действий пользователей. 

| Инструменты |
| ------ |
| OpenJDK 17 |
| maven |
| Junit5 |
| Spring Boot |
| Kafka |
| Docker |
| PostgreSQL |
| Postman |
| Swagger |

## Для запуска приложения необходимо:
* [Установить докер](https://docs.docker.com/get-docker/)
* Скопировать репозиторий и перейте в папку с проектом

## Использование

Запуск приложения:
```shell
 $ docker-compose build --no-cache
 $ docker-compose up
```

Остановка приложения:
```shell
 $ docker-compose down
```

## Посмотреть результаты работы приложения
<details>
<summary>Посмотреть логи</summary>
	<br>
	<p> В проекте логируется основная информация о работе системы. А именно: </p>
	<ul>
		<li> Создание нового cdr-файла </li>
		<li> Отправка cdr-файла в brt-сервис </li>
		<li> Получение cdr-файла в brt-сервисе </li>
		<li> Информация о пополнение баланса абонента </li>
		<li> Информация о изменении тарифа абонента </li>
	</ul>
</details>

<details>
<summary>Посмотреть содержимое баз данных</summary>
	<br>
	<p>Для просмотра содержимого баз данных вместе с проектом подниматеся pgAdmin.</p>
	<p>Для доступа к базам данных через pgAdmin необходимо:</p>
	<ul>
		<li> Перейти по адресу localhost:5050 </li>
		<li> Авторизоваться </li>
		<ul>
			<li> Логин: admin@admin.com </li>
			<li> Пароль: password </li>
		</ul>
		<li> Добавить базу даннух CDR сервиса </li>
		<ul>
			<li> Add New Server </li>
			<li> General -> Name: cdr-service </li>
			<li> Connection -> Host name/address: cdr-service_db </li>
			<li> Connection -> Port: 5432 </li>
			<li> Connection -> Maintenance database: postgres </li>
			<li> Connection -> Username: postgres </li>
			<li> Connection -> Password: changemeinprod! </li>
		</ul>
		<li> Добавить базу данных BRT сервиса </li>
		<ul>
			<li> Add New Server </li>
			<li> General -> Name: brt-service </li>
			<li> Connection -> Host name/address: brt-service_db </li>
			<li> Connection -> Port: 5432 </li>
			<li> Connection -> Maintenance database: postgres </li>
			<li> Connection -> Username: postgres </li>
			<li> Connection -> Password: changemeinprod! </li>
		</ul>
  	</ul>
   	<p>Теперь вы можете просматривать содержимое баз данных cdr-сервиса и brt-сервиса. Для просмтра содержимого необходимо открыть Server(2)->cdr-service->Database(1)->postgres->Schemas(1)->public->Tables(2) или Serverы(2)->brt-service->Database(1)->postgres->Schemas(1)->public->Tables(3) соответственно. </p>
</details>

<details>
<summary>Отправка запросов в API</summary>
</details>


## CDR сервис
### Описание
CDR сервис имеет две основые функции: <br>
* Эмуляция работы коммутатора. Сервис генерирует данные о звонках, собирает из них CDR-файлы и отправляет в BRT сервис.
* Эмуляция действий абонентов. Сервис отправляет запросы на пополнение счета и смену тарифа в BRT сервис.
<details>
<summary>Обоснование возложенного на сервис функционала</summary>
<p>Функция эмуляции работы коммутатора была заложена в ТЗ CDR-сервиса. В то время, как эмуляция действий абонентов (пополнение счета, смена тарифа), задавалась как общее требованиее к проекту. Мы четко решили, что данный функционал должен быть реализован в рамках одного сервиса, чтобы держать временную согласованность. То есть в том же таймлайне, когда клиенты совершают звонки, эти же клиенты пополняют свои счета и меняют тарифы. Однако, данный подход имеет последствия.</p>
<p>В частности, если смотреть на данные в реальном времени они могут быть искажены. Это происходит из-за использования брокера сообщений в качестве посредника в передаче CDR-файлов. То есть может произойти ситуация, когда пользователь совершил звонок, а после пополнил счет. Но с точки зрения BRT ситуация будет выглядить по другому, потому-что информация о пополнение счета приходит сразу, а информация о звонке должна пройти через несколько итераций (запись в файл, хранение файла, пока в нем не наберется нужное количество записей, ожидание файла в очереди на обработку).</p>
<p>Но такая несогласованнасть с пополнением счета является вполне терпимой. А вот операция с изменением тарифа может привести к гораздо более серьезным последствиям. Например, в случае с клиентом, который совершает звонок и сразу после меняет тариф, произойдет следующее: BRT-сервис сначала изменит тариф, и только через какое-то время обработает запись о звонке клиента. И получается, что данные о звонке в BRT-сервисе будут обработаны по данным нового тарифа, хотя фактически совершлались по условиям прошлого. Мы видим два возможных решения. До совершения звонка, запрашивать данные о тарифе пользователя и передовать их как информацию о звонке в CDR-файле, либо хранить историю изменения состояний абонетов в BRT-сервисе. В рамках данного проекта мы не реализовывали соответствующее решение и рассматриваем это как дальнейшую точку роста проекта.</p>
<p>Так же можно было бы рассмотреть включение генерации действий абонентов в рамки BRT-сервиса. Это решило бы вышеописанные проблемы. Но такое решение мы считаем губительным для дальнейшего развития проекта. Так как мы видим проект логически разделенным на две части: генерация и биллинговый система. И в теории, сервис генерации можно заменить на реальный коммутатор и реаальных пользователей, а биллинговый сервис оставить без изменений. В то время, как включение генерации действий абонентов в рамки биллинговой системы делают это невозможным.</p>
</details>

<details>
<summary>Описание классов</summary>
</details>






HRS-service:
POST localhost:8083/calculate
JSON:
{
    "msisdn": 79999999999,
    "startTime": 1713866400,
    "endTime": 1713868200,
    "pricePerMinute": 1.5,
    "clientRemainingMinutes": 100,
    "lastPaymentTimestamp": 1669372200,
    "tariffMonthlyFee": 100,
    "tariffMinutesPlan": 500
}

Чтобы посмотерть таблицы CDR и BRT сервиса перейдите на localhost:5050. admin@admin.com password
и добавтье серверса:
BRT:
Название: любое
Адрес: brt-service_db
Порт: 5432
Логин: postgres
Пароль: changemeinprod!

CDR:
Название: любое
Адрес: cdr-service_db
Порт: 5432
Логин: postgres
Пароль: changemeinprod!

## Dictionary
* BRT – Billing Real Time
* CDR – Call Data Record
* HRS – High performance rating server
* msisdn  - Mobile Subscriber Integrated Services Digital Number
* PPM - price per minute
